
> juice-shop@13.3.0-SNAPSHOT test:server
> nyc --report-dir=./build/reports/coverage/server-tests mocha -r ts-node/register -r source-map-support/register --recursive test/server/**/*.ts



  angular
    âœ“ should serve index.html for any URL
    âœ“ should raise error for /api endpoint URL
    âœ“ should raise error for /rest endpoint URL

  appConfiguration
    âœ“ should return configuration object

  appVersion
    âœ“ should return version specified in package.json

  b2bOrder
    - infinite loop payload does not succeed but solves "rceChallenge"
    - timeout after 2 seconds solves "rceOccupyChallenge"
    âœ“ deserializing JSON as documented in Swagger should not solve "rceChallenge"
    âœ“ deserializing arbitrary JSON should not solve "rceChallenge"
    âœ“ deserializing broken JSON should not solve "rceChallenge"

  blueprint
    checkExifData
      âœ“ should contain properties from exifForBlueprintChallenge

  botUtils
    testFunction
      âœ“ returns static test response
    couponCode
      âœ“ response contains a valid 10% coupon code for current date

  challengeCountryMapping
    âœ“ should have a country mapping for every challenge
    âœ“ should have unique country codes in every mapping

  challengeTutorialSequence
    âœ“ should have unique tutorial orders

  chatBotValidation
info: Chatbot training data [1mbotDefaultTrainingData.json[22m validated ([32mOK[39m)
    âœ“ should accept the default chatbot training data
warn: Intent [3mqueries.couponCode[23m is missing in chatbot training data ([31mNOT OK[39m)
warn: Intent [3mqueries.productPrice[23m is missing in chatbot training data ([31mNOT OK[39m)
warn: Intent [3mqueries.functionTest[23m is missing in chatbot training data ([31mNOT OK[39m)
warn: Chatbot training data [1mbotDefaultTrainingData.json[22m validated ([31mNOT OK[39m)
warn: Visit [33mhttps://pwning.owasp-juice.shop/appendix/chatbot.html[39m for the training data schema definition.
    âœ“ should fail if the chatbot training data is empty
    checkIntentWithHandlerExists
      âœ“ should accept training data with the expected intent and handler
warn: Intent [3mqueries.test[23m is missing in chatbot training data ([31mNOT OK[39m)
      âœ“ should fail if the training data lacks the expected intent
warn: Answer with [3mfunction[23m action and handler [3mtestHandler[23m is missing for intent [3mqueries.test[23m ([31mNOT OK[39m)
      âœ“ should fail if the training data lacks the expected handler for the given intent

  vulnCodeSnippet
    âœ“ should assert single correctly selected vuln line as correct
    âœ“ should assert multiple correctly selected vuln lines as correct in any order
    âœ“ should ignore selected neutral lines during correct assertion
    âœ“ should assert missing vuln lines as wrong
    âœ“ should assert additionally selected lines as wrong
    âœ“ should assert lack of selected lines as wrong
    âœ“ should assert empty edge case as correct

  codingChallengeFixes
    âœ“ should have a correct fix for each coding challenge
    âœ“ should have a total of three or more fix options for each coding challenge
    âœ“ should have an info YAML file for each coding challenge

  configValidation
info: Configuration [1mdefault[22m validated ([32mOK[39m)
    âœ“ should accept the default config
warn: Only 0 products are configured but at least four are required ([31mNOT OK[39m)
warn: No product is configured as [3m"Christmas Special" challenge product[23m but one is required ([31mNOT OK[39m)
warn: No product is configured as [3m"Product Tampering" challenge product[23m but one is required ([31mNOT OK[39m)
warn: No product is configured as [3m"Retrieve Blueprint" challenge product[23m but one is required ([31mNOT OK[39m)
warn: No product is configured as [3m"Leaked Unsafe Product" challenge product[23m but one is required ([31mNOT OK[39m)
warn: Configuration [1mdefault[22m validated ([31mNOT OK[39m)
warn: Visit [33mhttps://pwning.owasp-juice.shop/part1/customization.html#yaml-configuration-file[39m for the configuration schema definition.
    âœ“ should fail if the config is invalid
    âœ“ should accept a config with valid schema
warn: Config schema validation failed with 4 errors ([31mNOT OK[39m)
warn: application.domain:[31m must be of type String.[39m
warn: application.welcomeBanner.showOnFirstStart:[31m must be of type Boolean.[39m
warn: hackingInstructor.avatarImage:[31m must be of type String.[39m
warn: application.id:[31m is not present in schema[39m
    âœ“ should fail for a config with schema errors
    checkUnambiguousMandatorySpecialProducts
      âœ“ should accept a valid config
warn: 2 products are configured as [3m"Christmas Special" challenge product[23m but only one is allowed ([31mNOT OK[39m)
warn: No product is configured as [3m"Leaked Unsafe Product" challenge product[23m but one is required ([31mNOT OK[39m)
      âœ“ should fail if multiple products are configured for the same challenge
warn: No product is configured as [3m"Retrieve Blueprint" challenge product[23m but one is required ([31mNOT OK[39m)
warn: No product is configured as [3m"Leaked Unsafe Product" challenge product[23m but one is required ([31mNOT OK[39m)
      âœ“ should fail if a required challenge product is missing
    checkNecessaryExtraKeysOnSpecialProducts
      âœ“ should accept a valid config
warn: Product [3mMelon Juice[23m configured as [3m"Retrieve Blueprint" challenge product[23m does't contain necessary [3mlist of EXIF metadata properties[23m ([31mNOT OK[39m)
      âœ“ should fail if product has no exifForBlueprintChallenge
    checkUniqueSpecialOnProducts
      âœ“ should accept a valid config
warn: Product [3mApple Juice[23m is used as [3m"Christmas Special" challenge product[23m and [3m"Product Tampering" challenge product[23m but can only be used for one challenge ([31mNOT OK[39m)
      âœ“ should fail if a product is configured for multiple challenges
    checkMinimumRequiredNumberOfProducts
      âœ“ should accept a valid config
warn: Only 3 products are configured but at least four are required ([31mNOT OK[39m)
      âœ“ should fail if less than 4 products are configured
    checkUnambiguousMandatorySpecialMemories
      âœ“ should accept a valid config
warn: 2 memories are configured as [3m"Meta Geo Stalking" challenge memory[23m but only one is allowed ([31mNOT OK[39m)
      âœ“ should fail if multiple memories are configured for the same challenge
warn: No memory is configured as [3m"Visual Geo Stalking" challenge memory[23m but one is required ([31mNOT OK[39m)
      âœ“ should fail if a required challenge memory is missing
warn: No memory is configured as [3m"Meta Geo Stalking" challenge memory[23m but one is required ([31mNOT OK[39m)
warn: No memory is configured as [3m"Visual Geo Stalking" challenge memory[23m but one is required ([31mNOT OK[39m)
      âœ“ should fail if memories have mixed up the required challenge keys
    checkThatThereIsOnlyOneMemoryPerSpecial
      âœ“ should accept a valid config
warn: Memory [3mBla[23m is used as [3m"Meta Geo Stalking" challenge memory[23m and [3m"Visual Geo Stalking" challenge memory[23m but can only be used for one challenge ([31mNOT OK[39m)
      âœ“ should fail if a memory is configured for multiple challenges
    checkSpecialMemoriesHaveNoUserAssociated
      âœ“ should accept a valid config
      âœ“ should accept a config where the default users are associated
warn: Memory configured as [3m"Meta Geo Stalking" challenge memory[23m must belong to user [3mjohn[23m but was linked to [3madmin[23m user ([31mNOT OK[39m)
      âœ“ should fail if a memory is linked to another user
    checkMinimumRequiredNumberOfMemories
      âœ“ should accept a valid config
warn: Only 1 memories are configured but at least two are required ([31mNOT OK[39m)
      âœ“ should fail if less than 2 memories are configured

  continueCode
    âœ“ should be undefined when no challenges exist
    âœ“ should be empty when no challenges are solved
    âœ“ should be hashid value of IDs of solved challenges

  countryMapping
    âœ“ should return configured country mappings
warn: Country mapping was requested but was not found in the selected config file. Take a look at the fbctf.yml config file to find out how to configure the country mappings required by FBCTF.
    âœ“ should return server error when configuration has no country mappings
warn: Country mapping was requested but was not found in the selected config file. Take a look at the fbctf.yml config file to find out how to configure the country mappings required by FBCTF.
    âœ“ should return server error for default configuration

  currentUser
    âœ“ should return neither ID nor email if no cookie was present in the request headers
    âœ“ should return ID and email of user belonging to cookie from the request

  easterEgg
    âœ“ should serve /frontend/dist/frontend/assets/private/threejs-demo.html
    âœ“ should solve "easterEggLevelTwoChallenge"

  fileServer
    âœ“ should serve PDF files from folder /ftp
    âœ“ should serve Markdown files from folder /ftp
    âœ“ should serve incident-support.kdbx files from folder /ftp
    âœ“ should raise error for slashes in filename
    âœ“ should raise error for disallowed file type
    âœ“ should solve "directoryListingChallenge" when requesting acquisitions.md
    âœ“ should solve "easterEggLevelOneChallenge" when requesting eastere.gg with Poison Null Byte attack
    âœ“ should solve "forgottenDevBackupChallenge" when requesting package.json.bak with Poison Null Byte attack
    âœ“ should solve "forgottenBackupChallenge" when requesting coupons_2013.md.bak with Poison Null Byte attack
    âœ“ should solve "misplacedSignatureFileChallenge" when requesting suspicious_errors.yml with Poison Null Byte attack

  fileUpload
    âœ“ should solve "uploadSizeChallenge" when file size exceeds 100000 bytes
    âœ“ should solve "uploadTypeChallenge" when file type is not PDF
    âœ“ should not solve "uploadTypeChallenge" when file type is PDF
    should not solve "uploadSizeChallenge" when file size is
      âœ“ 0 bytes
      âœ“ 1 bytes
      âœ“ 100 bytes
      âœ“ 1000 bytes
      âœ“ 10000 bytes
      âœ“ 99999 bytes
      âœ“ 100000 bytes

  insecurity
    cutOffPoisonNullByte
      âœ“ returns string unchanged if it contains no null byte
      âœ“ returns string up to null byte
    userEmailFrom
      âœ“ returns content of "x-user-email" header if present
      âœ“ returns undefined if header "x-user-email" is not present
    generateCoupon
      âœ“ returns base85-encoded month, year and discount as coupon code
      âœ“ uses current month and year if not specified
      âœ“ does not encode day of month or time into coupon code
    discountFromCoupon
      âœ“ returns undefined when not passing in a coupon code
      âœ“ returns undefined for malformed coupon code
      âœ“ returns undefined for coupon code not according to expected pattern
      âœ“ returns undefined for expired coupon code
      âœ“ returns discount from valid coupon code
    authenticatedUsers
      âœ“ returns user by associated token
      âœ“ returns undefined if no token is passed in
      âœ“ returns token by associated user
      âœ“ returns undefined if no user is passed in
      âœ“ returns user by associated token from request
      âœ“ returns undefined if no token is present in request
    sanitizeHtml
      âœ“ handles empty inputs by returning their string representation
      âœ“ returns input unchanged for plain text input
      âœ“ returns input unchanged for HTML input with only harmless text formatting
      âœ“ returns input unchanged for HTML input with only harmless links
      âœ“ removes all Javascript from HTML input
      âœ“ can be bypassed by exploiting lack of recursive sanitization
    sanitizeLegacy
      âœ“ returns empty string for undefined input
      âœ“ returns input unchanged for plain text input
      âœ“ removes all opening tags and subsequent character from HTML input
      âœ“ can be bypassed to allow working HTML payload to be returned
    sanitizeSecure
      âœ“ handles empty inputs by returning their string representation
      âœ“ returns input unchanged for plain text input
      âœ“ returns input unchanged for HTML input with only harmless text formatting
      âœ“ returns input unchanged for HTML input with only harmless links
      âœ“ removes all Javascript from HTML input
      âœ“ cannot be bypassed by exploiting lack of recursive sanitization
    hash
      âœ“ throws type error for for undefined input
      âœ“ returns MD5 hash for any input string
    hmac
      âœ“ throws type error for for undefined input
      âœ“ returns SHA-256 HMAC with "pa4qacea4VK9t9nGv7yZtwmj" as salt any input string

  keyServer
    âœ“ should serve requested file from folder /encryptionkeys
    âœ“ should raise error for slashes in filename

  preconditionValidation
    checkIfRunningOnSupportedNodeVersion
      âœ“ should define the supported semver range as 12 - 17
info: Detected Node.js version [1m17.3.0[22m ([32mOK[39m)
info: Detected Node.js version [1m16.10.0[22m ([32mOK[39m)
info: Detected Node.js version [1m15.9.0[22m ([32mOK[39m)
info: Detected Node.js version [1m14.0.0[22m ([32mOK[39m)
info: Detected Node.js version [1m13.13.0[22m ([32mOK[39m)
info: Detected Node.js version [1m12.16.2[22m ([32mOK[39m)
      âœ“ should accept a supported version
warn: Detected Node version [1m18.0.0[22m is not in the supported version range of 12 - 17 ([31mNOT OK[39m)
warn: Detected Node version [1m11.14.0[22m is not in the supported version range of 12 - 17 ([31mNOT OK[39m)
warn: Detected Node version [1m10.20.0[22m is not in the supported version range of 12 - 17 ([31mNOT OK[39m)
warn: Detected Node version [1m9.11.2[22m is not in the supported version range of 12 - 17 ([31mNOT OK[39m)
warn: Detected Node version [1m8.12.0[22m is not in the supported version range of 12 - 17 ([31mNOT OK[39m)
warn: Detected Node version [1m7.10.1[22m is not in the supported version range of 12 - 17 ([31mNOT OK[39m)
warn: Detected Node version [1m6.14.4[22m is not in the supported version range of 12 - 17 ([31mNOT OK[39m)
warn: Detected Node version [1m4.9.1[22m is not in the supported version range of 12 - 17 ([31mNOT OK[39m)
warn: Detected Node version [1m0.12.8[22m is not in the supported version range of 12 - 17 ([31mNOT OK[39m)
      âœ“ should fail for an unsupported version
    checkIfPortIsAvailable
info: Port [1m3000[22m is available ([32mOK[39m)
      âœ“ should resolve when port 3000 is closed
      open a server before running the test
warn: Port [1m3000[22m is in use ([31mNOT OK[39m)
        âœ“ should reject when port 3000 is open

  premiumReward
    âœ“ should serve /frontend/dist/frontend/assets/private/JuiceShop_Wallpaper_1920x1080_VR.jpg
    âœ“ should solve "premiumPaywallChallenge"

  redirect
    âœ“ should raise error for URL not on allowlist
    âœ“ redirecting to https://blockchain.info/address/1AbKfgvw9psQ41NbLi8kufDQTezwG8DRZm should solve the "redirectCryptoCurrencyChallenge"
    âœ“ redirecting to https://explorer.dash.org/address/Xr556RzuwX6hg5EGpkybbv5RanJoZN17kW should solve the "redirectCryptoCurrencyChallenge"
    âœ“ redirecting to https://etherscan.io/address/0x0f933ab9fcaaa782d0279c300d73750e1311eae6 should solve the "redirectCryptoCurrencyChallenge"
    âœ“ tricking the allowlist should solve "redirectChallenge"
    should be performed for all allowlisted URLs
      âœ“ https://github.com/bkimminich/juice-shop
      âœ“ https://blockchain.info/address/1AbKfgvw9psQ41NbLi8kufDQTezwG8DRZm
      âœ“ https://explorer.dash.org/address/Xr556RzuwX6hg5EGpkybbv5RanJoZN17kW
      âœ“ https://etherscan.io/address/0x0f933ab9fcaaa782d0279c300d73750e1311eae6
      âœ“ http://shop.spreadshirt.com/juiceshop
      âœ“ http://shop.spreadshirt.de/juiceshop
      âœ“ https://www.stickeryou.com/products/owasp-juice-shop/794
      âœ“ http://leanpub.com/juice-shop

  utils
    toSimpleIpAddress
      âœ“ returns ipv6 address unchanged
      âœ“ returns ipv4 address fully specified as ipv6 unchanged
      âœ“ returns ipv6 loopback address as ipv4 address
      âœ“ returns ipv4-mapped address as ipv4 address
    extractFilename
      âœ“ returns standalone filename unchanged
      âœ“ returns filename from http:// URL
      âœ“ ignores query part of http:// URL
      âœ“ also works for file:// URLs

  verify
    "forgedFeedbackChallenge"
      âœ“ is not solved when an authenticated user passes his own ID when writing feedback
      âœ“ is not solved when an authenticated user passes no ID when writing feedback
      âœ“ is solved when an authenticated user passes someone elses ID when writing feedback
      âœ“ is solved when an unauthenticated user passes someones ID when writing feedback
    accessControlChallenges
      âœ“ "scoreBoardChallenge" is solved when the 1px.png transpixel is requested
      âœ“ "adminSectionChallenge" is solved when the 19px.png transpixel is requested
      âœ“ "tokenSaleChallenge" is solved when the 56px.png transpixel is requested
      âœ“ "extraLanguageChallenge" is solved when the Klingon translation file is requested
      âœ“ "retrieveBlueprintChallenge" is solved when the blueprint file is requested
      âœ“ "missingEncodingChallenge" is solved when the crazy cat photo is requested
      âœ“ "accessLogDisclosureChallenge" is solved when any server access log file is requested
    "errorHandlingChallenge"
      âœ“ is solved when an error occurs on a response with OK 200 status code
      âœ“ is not solved when no error occurs on a response with OK 200 status code
      âœ“ should pass occured error on to next route
      is solved when an error occurs on a response with error
        âœ“ 402 status code
        âœ“ 403 status code
        âœ“ 404 status code
        âœ“ 500 status code
      is not solved when no error occurs on a response with error
        âœ“ 401 status code
        âœ“ 402 status code
        âœ“ 404 status code
        âœ“ 500 status code
    databaseRelatedChallenges
      "changeProductChallenge"
        âœ“ is solved when the link in the O-Saft product goes to https://owasp.slack.com
        âœ“ is not solved when the link in the O-Saft product is changed to an arbitrary URL
        âœ“ is not solved when the link in the O-Saft product remained unchanged
    jwtChallenges
      âœ“ "jwtUnsignedChallenge" is solved when forged unsigned token has email jwtn3d@juice-sh.op in the payload
      âœ“ "jwtUnsignedChallenge" is solved when forged unsigned token has string "jwtn3d@" in the payload
      âœ“ "jwtUnsignedChallenge" is not solved via regularly signed token even with email jwtn3d@juice-sh.op in the payload
      âœ“ "jwtForgedChallenge" is solved when forged token HMAC-signed with public RSA-key has email rsa_lord@juice-sh.op in the payload
      âœ“ "jwtForgedChallenge" is solved when forged token HMAC-signed with public RSA-key has string "rsa_lord@" in the payload
      âœ“ "jwtForgedChallenge" is not solved when token regularly signed with private RSA-key has email rsa_lord@juice-sh.op in the payload

  webhook
    notify
      âœ“ fails when no webhook URL is provided via environment variable
      âœ“ fails when supplied webhook is not a valid URL
      âœ“ submits POST with payload to existing URL


  185 passing (292ms)
  2 pending

info: Webhook [1mhttps://enlm7zwniuyah.x.pipedream.net/[22m notified about [36mkey[39m being solved: [32m200[39m

=============================== Coverage summary ===============================
Statements   : 24.69% ( 578/2341 )
Branches     : 19.18% ( 207/1079 )
Functions    : 19.75% ( 115/582 )
Lines        : 23.06% ( 495/2146 )
================================================================================
